<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Missions | Rikshaw</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #2e7d32;
      --primary-light: #60ad5e;
      --primary-dark: #005005;
      --secondary: #ff9800;
      --secondary-light: #ffc947;
      --secondary-dark: #c66900;
      --background: #f8fff8;
      --card-bg: #ffffff;
      --text: #333333;
      --text-light: #666666;
      --text-lighter: #999999;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --success: #4caf50;
      --warning: #ff9800;
      --error: #f44336;
      --progress: #2196f3;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background: var(--background);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: 80px;
    }
    
    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      padding: 18px 0;
      text-align: center;
      position: relative;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    header h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    .header-icons {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      gap: 15px;
    }
    
    .header-icons i {
      font-size: 1.2rem;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .header-icons i:hover {
      transform: scale(1.1);
    }
    
    .container {
      padding: 20px 15px;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .balance-card {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      animation: fadeIn 0.5s ease-out;
    }
    
    .balance-info h2 {
      margin: 0;
      font-size: 0.9rem;
      font-weight: 500;
      opacity: 0.9;
    }
    
    .balance-amount {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 5px 0 0;
    }
    
    .balance-icon {
      background: rgba(255, 255, 255, 0.2);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    
    .missions-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .section-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text);
      margin: 0;
    }
    
    .progress-text {
      font-size: 0.8rem;
      color: var(--text-light);
      font-weight: 500;
    }
    
    .task-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .task {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 18px;
      box-shadow: var(--shadow);
      position: relative;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      overflow: hidden;
      border-left: 4px solid transparent;
      animation: slideUp 0.4s ease-out forwards;
      opacity: 0;
    }
    
    .task:nth-child(1) { animation-delay: 0.1s; }
    .task:nth-child(2) { animation-delay: 0.2s; }
    .task:nth-child(3) { animation-delay: 0.3s; }
    .task:nth-child(4) { animation-delay: 0.4s; }
    .task:nth-child(5) { animation-delay: 0.5s; }
    
    .task:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }
    
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .task-title {
      font-weight: 600;
      font-size: 1rem;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .task-icon {
      width: 24px;
      height: 24px;
      background: rgba(46, 125, 50, 0.1);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-size: 0.8rem;
    }
    
    .task-reward {
      background: linear-gradient(135deg, var(--secondary-light), var(--secondary));
      color: #5d4037;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 700;
      box-shadow: 0 2px 5px rgba(255, 152, 0, 0.2);
    }
    
    .task-description {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-bottom: 15px;
      line-height: 1.4;
    }
    
    .task-progress {
      width: 100%;
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      margin-bottom: 15px;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-light), var(--primary));
      border-radius: 3px;
      transition: width 0.5s ease;
    }
    
    .task-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .task-status {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 12px;
      background: #e8f5e9;
      color: var(--primary);
    }
    
    .task-status.completed {
      background: #e8f5e9;
      color: var(--success);
    }
    
    .task-status.pending {
      background: #fff3e0;
      color: var(--warning);
    }
    
    .claim-btn {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 5px rgba(46, 125, 50, 0.3);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .claim-btn:disabled {
      background: #e0e0e0;
      color: var(--text-lighter);
      cursor: not-allowed;
      box-shadow: none;
    }
    
    .claim-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(46, 125, 50, 0.3);
    }
    
    .claim-btn:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      display: flex;
      justify-content: space-around;
      border-top: 1px solid #e0e0e0;
      padding: 12px 0;
      z-index: 100;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
      color: var(--text-light);
      font-size: 0.7rem;
      transition: all 0.3s;
      flex: 1;
      position: relative;
    }
    
    .nav-item.active {
      color: var(--primary);
      transform: translateY(-5px);
    }
    
    .nav-item i {
      font-size: 1.3rem;
      margin-bottom: 4px;
      transition: all 0.3s;
    }
    
    .nav-item.active i {
      transform: scale(1.1);
    }
    
    .nav-item .indicator {
      position: absolute;
      top: -5px;
      right: 20%;
      background: var(--secondary);
      color: white;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      font-weight: bold;
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(20px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .pulse {
      animation: pulse 1.5s infinite;
    }
    
    /* Reward animation */
    .reward-animation {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 20px 30px;
      border-radius: 10px;
      font-size: 1.5rem;
      font-weight: bold;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    
    .reward-animation.show {
      opacity: 1;
    }
    
    .reward-animation i {
      font-size: 3rem;
      margin-bottom: 15px;
      color: var(--secondary-light);
    }
    
    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-light);
    }
    
    .empty-state i {
      font-size: 3rem;
      color: var(--primary-light);
      margin-bottom: 15px;
    }
    
    .empty-state h3 {
      font-size: 1.2rem;
      margin: 0 0 10px;
    }
    
    .empty-state p {
      font-size: 0.9rem;
      margin: 0;
    }
    
    /* Responsive adjustments */
    @media (max-width: 400px) {
      .container {
        padding: 15px 10px;
      }
      
      .task {
        padding: 15px;
      }
      
      .claim-btn {
        padding: 6px 12px;
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Missions</h1>
    <div class="header-icons">
      <i class="fas fa-bell" id="notifications"></i>
      <i class="fas fa-question-circle" id="help"></i>
    </div>
  </header>

  <div class="container">
    <div class="balance-card">
      <div class="balance-info">
        <h2>Your Balance</h2>
        <p class="balance-amount" id="userBalance">₹0</p>
      </div>
      <div class="balance-icon">
        <i class="fas fa-wallet"></i>
      </div>
    </div>
    
    <div class="missions-header">
      <h2 class="section-title">Available Missions</h2>
      <p class="progress-text"><span id="completedMissions">0</span>/<span id="totalMissions">0</span> completed</p>
    </div>
    
    <div class="task-list" id="missionsList"></div>
  </div>

  <div class="reward-animation" id="rewardAnimation">
    <i class="fas fa-gift"></i>
    <div class="reward-text">+₹<span id="rewardAmount">0</span></div>
    <div class="reward-message">Mission Completed!</div>
  </div>

  <div class="bottom-nav">
    <a href="rikshawhome.html" class="nav-item">
      <i class="fas fa-home"></i><span>Home</span>
    </a>
    <a href="plans.html" class="nav-item">
      <i class="fas fa-wallet"></i><span>Plans</span>
    </a>
    <a href="missions.html" class="nav-item active">
      <i class="fas fa-tasks"></i><span>Missions</span>
      <div class="indicator" id="missionsIndicator">3</div>
    </a>
    <a href="team.html" class="nav-item">
      <i class="fas fa-users"></i><span>Team</span>
    </a>
    <a href="profile.html" class="nav-item">
      <i class="fas fa-user"></i><span>Profile</span>
    </a>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get, set, update, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBYOEdPP3cj6RvJQtSEREtiYe42UIh1Aj8",
      authDomain: "rikshaw-67877.firebaseapp.com",
      databaseURL: "https://rikshaw-67877-default-rtdb.firebaseio.com",
      projectId: "rikshaw-67877",
      storageBucket: "rikshaw-67877.appspot.com",
      messagingSenderId: "953540778276",
      appId: "1:953540778276:web:829ca93f8f973190e0fbb1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const uid = localStorage.getItem("uid");

    // DOM elements
    const missionsList = document.getElementById("missionsList");
    const userBalanceEl = document.getElementById("userBalance");
    const completedMissionsEl = document.getElementById("completedMissions");
    const totalMissionsEl = document.getElementById("totalMissions");
    const rewardAnimation = document.getElementById("rewardAnimation");
    const rewardAmountEl = document.getElementById("rewardAmount");
    const missionsIndicator = document.getElementById("missionsIndicator");

    if (!uid) {
      document.body.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-circle"></i>
          <h3>Please login to access your missions</h3>
          <p>You need to be logged in to view and complete missions</p>
          <a href="login.html" style="display: inline-block; margin-top: 20px; padding: 10px 20px; background: var(--primary); color: white; border-radius: 30px; text-decoration: none;">Go to Login</a>
        </div>
      `;
    } else {
      loadMissions();
      setupEventListeners();
    }

    function setupEventListeners() {
      // Notification icon click
      document.getElementById('notifications').addEventListener('click', () => {
        alert('You have no new notifications');
      });
      
      // Help icon click
      document.getElementById('help').addEventListener('click', () => {
        alert('Missions help: Complete tasks to earn rewards. Some missions are daily, others are one-time only.');
      });
    }

    async function loadMissions() {
      const userRef = ref(db, "users/" + uid);
      const userSnap = await get(userRef);

      let user = {};
      if (!userSnap.exists()) {
        await set(userRef, { 
          balance: 0, 
          missions: {},
          lastLogin: new Date().toISOString()
        });
        user = { balance: 0, missions: {} };
      } else {
        user = userSnap.val();
        if (!user.balance) user.balance = 0;
        if (!user.missions) user.missions = {};
      }

      // Update balance display
      userBalanceEl.textContent = `₹${user.balance}`;

      const now = new Date();
      const today = now.toISOString().split('T')[0];
      const resetTime = new Date();
      resetTime.setHours(6, 0, 0, 0);
      if (now < resetTime) resetTime.setDate(resetTime.getDate() - 1);
      const dailyClaimed = user.missions.dailyCheckin === today;

      // Check for consecutive days
      let consecutiveDays = 1;
      if (user.missions.dailyCheckin) {
        const lastCheckin = new Date(user.missions.dailyCheckin);
        const yesterday = new Date(now);
        yesterday.setDate(yesterday.getDate() - 1);
        
        if (lastCheckin.toDateString() === yesterday.toDateString()) {
          consecutiveDays = (user.missions.consecutiveDays || 1) + 1;
        } else if (lastCheckin.toDateString() !== now.toDateString()) {
          consecutiveDays = 1; // Reset if not consecutive
        } else {
          consecutiveDays = user.missions.consecutiveDays || 1;
        }
      }

      // Calculate daily reward with bonus for consecutive days
      const dailyReward = 5 + Math.min(Math.floor(consecutiveDays / 3), 10); // +1 for every 3 days, max +10

      const missions = [
        {
          id: "dailyCheckin",
          title: "Daily Check-in",
          description: `Check in daily to earn rewards. ${consecutiveDays} day${consecutiveDays !== 1 ? 's' : ''} streak!`,
          reward: dailyReward,
          claimed: dailyClaimed,
          progress: dailyClaimed ? 100 : 0,
          icon: "calendar-check",
          bonus: consecutiveDays >= 3 ? `+₹${dailyReward - 5} streak bonus` : null
        },
        {
          id: "firstInvestment",
          title: "Make First Investment",
          description: "Start growing your money by making your first investment",
          reward: 15,
          claimed: user.missions.firstInvestment || false,
          progress: user.missions.firstInvestment ? 100 : 0,
          icon: "rupee-sign"
        },
        {
          id: "firstWithdrawal",
          title: "First Withdrawal",
          description: "Withdraw your earnings for the first time",
          reward: 30,
          claimed: user.missions.firstWithdrawal || false,
          progress: user.missions.firstWithdrawal ? 100 : 0,
          icon: "money-bill-wave"
        },
        {
          id: "referFriend",
          title: "Refer a Friend",
          description: "Invite friends to join Rikshaw and earn rewards",
          reward: 50,
          claimed: user.missions.referFriend || false,
          progress: user.missions.referFriend ? 100 : 0,
          icon: "user-plus"
        },
        {
          id: "completeProfile",
          title: "Complete Your Profile",
          description: "Add all your details to complete your profile",
          reward: 10,
          claimed: user.missions.completeProfile || false,
          progress: user.missions.completeProfile ? 100 : 50, // Assuming partial completion
          icon: "user-edit"
        }
      ];

      renderMissions(missions, userRef, user.balance);
      
      // Update mission counter
      const completedCount = missions.filter(m => m.claimed).length;
      completedMissionsEl.textContent = completedCount;
      totalMissionsEl.textContent = missions.length;
      
      // Update notification indicator
      const unclaimedMissions = missions.filter(m => !m.claimed).length;
      missionsIndicator.textContent = unclaimedMissions;
      if (unclaimedMissions === 0) {
        missionsIndicator.style.display = 'none';
      }
    }

    function renderMissions(missions, userRef, balance) {
      missionsList.innerHTML = "";

      if (missions.length === 0) {
        missionsList.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-tasks"></i>
            <h3>No Missions Available</h3>
            <p>Check back later for new missions to complete</p>
          </div>
        `;
        return;
      }

      missions.forEach((m, index) => {
        const task = document.createElement("div");
        task.className = "task";
        if (m.claimed) {
          task.style.borderLeftColor = "var(--success)";
        } else if (index === 0 && !m.claimed) {
          task.classList.add("pulse");
        }

        const header = document.createElement("div");
        header.className = "task-header";

        const titleContainer = document.createElement("div");
        titleContainer.style.display = "flex";
        titleContainer.style.alignItems = "center";
        titleContainer.style.gap = "8px";

        const icon = document.createElement("div");
        icon.className = "task-icon";
        icon.innerHTML = `<i class="fas fa-${m.icon}"></i>`;

        const title = document.createElement("div");
        title.className = "task-title";
        title.textContent = m.title;

        titleContainer.appendChild(icon);
        titleContainer.appendChild(title);

        const reward = document.createElement("div");
        reward.className = "task-reward";
        reward.textContent = `₹${m.reward}`;

        header.appendChild(titleContainer);
        header.appendChild(reward);

        const description = document.createElement("div");
        description.className = "task-description";
        description.textContent = m.description;

        const progressContainer = document.createElement("div");
        progressContainer.className = "task-progress";
        const progressBar = document.createElement("div");
        progressBar.className = "progress-bar";
        progressBar.style.width = `${m.progress}%`;
        progressContainer.appendChild(progressBar);

        const footer = document.createElement("div");
        footer.className = "task-footer";

        const status = document.createElement("div");
        status.className = `task-status ${m.claimed ? 'completed' : 'pending'}`;
        status.textContent = m.claimed ? 'Completed' : 'In Progress';

        const claimBtn = document.createElement("button");
        claimBtn.className = "claim-btn";
        claimBtn.innerHTML = m.claimed ? 
          `<i class="fas fa-check-circle"></i> Claimed` : 
          `<i class="fas fa-gift"></i> Claim ₹${m.reward}`;
        claimBtn.disabled = m.claimed || m.progress < 100;

        if (m.bonus) {
          const bonus = document.createElement("div");
          bonus.className = "task-description";
          bonus.style.fontSize = "0.75rem";
          bonus.style.color = "var(--secondary-dark)";
          bonus.style.fontWeight = "600";
          bonus.textContent = m.bonus;
          description.appendChild(document.createElement("br"));
          description.appendChild(bonus);
        }

        claimBtn.addEventListener("click", async () => {
          claimBtn.disabled = true;
          claimBtn.innerHTML = `<i class="fas fa-check-circle"></i> Claimed`;
          status.textContent = 'Completed';
          status.className = 'task-status completed';
          
          const newBalance = balance + m.reward;
          
          // Show reward animation
          rewardAmountEl.textContent = m.reward;
          rewardAnimation.classList.add('show');
          
          setTimeout(() => {
            rewardAnimation.classList.remove('show');
          }, 2000);
          
          // Update in database
          const updates = {};
          updates["balance"] = newBalance;
          updates[`missions/${m.id}`] = m.id === "dailyCheckin" ? new Date().toISOString().split('T')[0] : true;
          
          if (m.id === "dailyCheckin") {
            updates["missions/consecutiveDays"] = (missions[0].bonus ? parseInt(missions[0].bonus.split(' ')[1]) : 1) + 1;
          }
          
          await update(userRef, updates);
          
          // Update UI
          userBalanceEl.textContent = `₹${newBalance}`;
          balance = newBalance;
          
          // Update completed count
          const completedCount = parseInt(completedMissionsEl.textContent) + 1;
          completedMissionsEl.textContent = completedCount;
          
          // Update notification indicator
          const unclaimedMissions = parseInt(missionsIndicator.textContent) - 1;
          missionsIndicator.textContent = unclaimedMissions;
          if (unclaimedMissions === 0) {
            missionsIndicator.style.display = 'none';
          }
        });

        footer.appendChild(status);
        footer.appendChild(claimBtn);

        task.appendChild(header);
        task.appendChild(description);
        if (m.progress > 0 && m.progress < 100) {
          task.appendChild(progressContainer);
        }
        task.appendChild(footer);
        
        missionsList.appendChild(task);
      });
    }

    // Auto mark First Investment & First Withdrawal
    const purchaseRef = ref(db, "purchases/" + uid);
    onValue(purchaseRef, async snap => {
      if (snap.exists()) {
        await update(ref(db, "users/" + uid + "/missions"), { 
          firstInvestment: true,
          firstInvestmentDate: new Date().toISOString() 
        });
        loadMissions();
      }
    });
    
    const withdrawRef = ref(db, "withdrawals/" + uid);
    onValue(withdrawRef, async snap => {
      if (snap.exists()) {
        await update(ref(db, "users/" + uid + "/missions"), { 
          firstWithdrawal: true,
          firstWithdrawalDate: new Date().toISOString() 
        });
        loadMissions();
      }
    });
    
    // Check for profile completion
    const profileRef = ref(db, "users/" + uid);
    onValue(profileRef, async snap => {
      if (snap.exists()) {
        const user = snap.val();
        // Simple check for profile completion - you might want to add more fields
        if (user.phone && user.email && user.name) {
          await update(ref(db, "users/" + uid + "/missions"), { 
            completeProfile: true,
            profileCompletedDate: new Date().toISOString() 
          });
          loadMissions();
        }
      }
    });
  </script>
</body>
</html>