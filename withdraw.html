<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Withdraw - Eco Rikshaw</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #00e64d;
      --secondary-color: #009933;
      --dark-color: #006622;
      --light-color: #e6ffe6;
      --error-color: #ff4444;
      --warning-color: #ffbb33;
    }
    body {
      margin: 0;
      background: #f5f5f5;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
      min-height: 100vh;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      background: var(--primary-color);
      color: white;
      padding: 15px 0;
      text-align: center;
      border-radius: 0 0 20px 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--dark-color);
    }
    .card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .balance-box {
      text-align: center;
      font-size: 18px;
      position: relative;
    }
    .balance-amount {
      font-size: 28px;
      font-weight: bold;
      color: var(--secondary-color);
      margin: 10px 0;
    }
    .input-group {
      margin-bottom: 20px;
      position: relative;
    }
    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }
    .input-group input {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ddd;
      box-sizing: border-box;
      transition: all 0.3s;
    }
    .input-group input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 230, 77, 0.2);
      outline: none;
    }
    button {
      background: var(--secondary-color);
      color: white;
      padding: 16px;
      font-size: 18px;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      width: 100%;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    button:hover {
      background: var(--dark-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    button:active {
      transform: translateY(0);
    }
    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .error-message {
      color: var(--error-color);
      font-size: 14px;
      margin-top: -10px;
      margin-bottom: 10px;
      display: none;
    }
    .success-message {
      display: none;
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
    }
    .processing-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .processing-text {
      color: white;
      margin-top: 20px;
      font-size: 18px;
    }
    .note-box {
      background-color: var(--light-color);
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      font-size: 14px;
    }
    .note-box ul {
      margin: 10px 0;
      padding-left: 20px;
    }
    .note-box li {
      margin-bottom: 5px;
    }
  </style>
</head>
<body>

<header>
  <div class="container">
    <h1>Withdraw Funds</h1>
  </div>
</header>

<div class="container">
  <div class="card balance-box">
    <div>Available Balance</div>
    <div class="balance-amount">₹<span id="balance">0</span></div>
    <div>Withdraw to your bank account via UPI</div>
  </div>

  <div class="card">
    <h2>Withdrawal Request</h2>
    
    <div class="input-group">
      <label for="amount">Amount (₹)</label>
      <input type="number" id="amount" placeholder="Enter amount (Min ₹190)" min="190" />
      <div id="amount-error" class="error-message">Minimum withdrawal is ₹190</div>
    </div>
    
    <div class="input-group">
      <label for="upi">UPI ID</label>
      <input type="text" id="upi" placeholder="Enter your UPI ID (e.g., name@upi)" />
      <div id="upi-error" class="error-message">Please enter a valid UPI ID</div>
    </div>
    
    <div id="success-message" class="success-message">
      <i class="fas fa-check-circle"></i> Withdrawal request submitted successfully!
    </div>
    
    <button id="withdraw-btn" onclick="withdraw()">
      <i class="fas fa-rupee-sign"></i> Request Withdraw
    </button>
    
    <div class="note-box">
      <strong>Important Notes:</strong>
      <ul>
        <li>Minimum withdrawal amount is ₹190</li>
        <li>Withdrawal processing may take 24-48 hours</li>
        <li>Ensure your UPI ID is correct before submitting</li>
        <li>Amount will be deducted immediately upon withdrawal request</li>
      </ul>
    </div>
  </div>
</div>

<div class="processing-overlay" id="processing-overlay">
  <div style="text-align: center;">
    <div class="spinner"></div>
    <div class="processing-text">Processing your withdrawal...</div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, get, update, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBYOEdPP3cj6RvJQtSEREtiYe42UIh1Aj8",
    authDomain: "rikshaw-67877.firebaseapp.com",
    databaseURL: "https://rikshaw-67877-default-rtdb.firebaseio.com",
    projectId: "rikshaw-67877",
    storageBucket: "rikshaw-67877.appspot.com",
    messagingSenderId: "953540778276",
    appId: "1:953540778276:web:829ca93f8f973190e0fbb1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase();
  const auth = getAuth();

  let userRef;
  let currentBalance = 0;

  onAuthStateChanged(auth, (user) => {
    if (user) {
      userRef = ref(db, "users/" + user.uid);
      get(userRef).then(snapshot => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          currentBalance = data.balance || 0;
          document.getElementById("balance").textContent = currentBalance.toFixed(2);
        }
      });
    } else {
      window.location.href = "login.html";
    }
  });

  function validateInputs(amount, upi) {
    let isValid = true;
    const amountError = document.getElementById("amount-error");
    const upiError = document.getElementById("upi-error");
    amountError.style.display = "none";
    upiError.style.display = "none";

    if (isNaN(amount) || amount < 190) {
      amountError.textContent = "Minimum withdrawal is ₹190";
      amountError.style.display = "block";
      isValid = false;
    } else if (amount > currentBalance) {
      amountError.textContent = "Insufficient balance";
      amountError.style.display = "block";
      isValid = false;
    }

    const upiRegex = /^[a-zA-Z0-9.\-_]{2,256}@[a-zA-Z]{2,64}$/;
    if (!upiRegex.test(upi)) {
      upiError.textContent = "Enter valid UPI ID (e.g., name@upi)";
      upiError.style.display = "block";
      isValid = false;
    }
    return isValid;
  }

  async function withdraw() {
    const amount = parseFloat(document.getElementById("amount").value);
    const upi = document.getElementById("upi").value.trim();
    const withdrawBtn = document.getElementById("withdraw-btn");
    const processingOverlay = document.getElementById("processing-overlay");

    if (!validateInputs(amount, upi)) return;

    // Show processing overlay
    processingOverlay.style.display = "flex";
    withdrawBtn.disabled = true;

    try {
      // Get latest balance
      const snapshot = await get(userRef);
      const user = snapshot.val();
      const currentBalance = user.balance || 0;
      
      if (amount > currentBalance) {
        document.getElementById("amount-error").textContent = "Insufficient balance";
        document.getElementById("amount-error").style.display = "block";
        processingOverlay.style.display = "none";
        withdrawBtn.disabled = false;
        return;
      }

      // Calculate new balance
      const newBalance = currentBalance - amount;
      
      // Update user balance
      await update(userRef, {
        balance: newBalance
      });

      // Record the withdrawal request
      const requestsRef = ref(db, "withdrawRequests");
      await push(requestsRef, {
        uid: auth.currentUser.uid,
        username: user.username || "Unknown",
        amount,
        upi,
        status: "pending",
        time: new Date().toISOString()
      });

      // Update UI
      document.getElementById("success-message").style.display = "block";
      document.getElementById("balance").textContent = newBalance.toFixed(2);
      currentBalance = newBalance;
      
      // Reset form after delay
      setTimeout(() => {
        document.getElementById("success-message").style.display = "none";
        document.getElementById("amount").value = "";
        document.getElementById("upi").value = "";
        processingOverlay.style.display = "none";
        withdrawBtn.disabled = false;
      }, 3000);
    } catch (error) {
      console.error("Withdrawal error:", error);
      alert("An error occurred during withdrawal. Please try again.");
      processingOverlay.style.display = "none";
      withdrawBtn.disabled = false;
    }
  }
</script>
</body>
</html>